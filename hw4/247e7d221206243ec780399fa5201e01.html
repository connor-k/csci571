<!DOCTYPE html>
<html lang="en">
<html>
<head>
<meta charset="UTF-8">
<title>ckerns HW4 - XML</title>

<script>
function generateHTML(xmlDoc) {
    // MS parser doesn't define Node.ELEMENT_NODE
    var ELEMENT_NODE = 1;
    // TODO looks like they used a lot of globals -- remove them later
    root = xmlDoc.DocumentElement;
    debug = xmlDoc;
    html_text = "<html><head><title>XML Parse Result</title></head><body>";
    html_text += "<table border='2'>";
    table = xmlDoc.getElementsByTagName("Table").item(0).children;
    // Check that there's data
    if (table.length < 2) {
        throw("Error in XML file: Missing tags."); //TODO check
    }
    // Titles
    tableTitleSection = table[0];
    if (tableTitleSection.nodeName != "Header") {
        throw("Error in XML file: Missing header tag as first element.");
    }
    html_text += "<thead><tr>";
    tableColTitles = tableTitleSection.children;
    for (var i = 0; i < tableColTitles.length; i++) {
        // Check that it's an element node
        if (tableColTitles[i].nodeName == "Data" && tableColTitles[i].nodeType == ELEMENT_NODE) {
            var colName = tableColTitles[i].innerHTML;
            html_text += "<th>" + colName + "</th>";
            //TODO check if can be empty?
        } else {
            throw("Error in XML file: invalid data tag in headers.");
        }
    }
    html_text += "</tr></thead>";
    html_text += "<tbody>"
    // Rows of data
    for (var i = 1; i < table.length; i++) {
        // Check that it's an element node
        if (table[i].nodeName == "Row" && table[i].nodeType == ELEMENT_NODE) {
            html_text += "<tr>";
            rowNode = table[i].children;
            // TODO check len?
            for (var j = 0; j < rowNode.length; j++) {
                html_text += "<td>";
                // TODO enforce order??
                // TODO check that matches headers?
                if (rowNode[j].nodeName == "CallSign" || rowNode[j].nodeName == "Frequency" || rowNode[j].nodeName == "Format") {
                    html_text += rowNode[j].innerHTML;
                } else if (rowNode[j].nodeName == "Location") {
                    locationNode = rowNode[j].children;
                    if (locationNode.length > 0) {
                        html_text += "<ul>";
                        for (var k = 0; k < locationNode.length; k++) {
                            html_text += "<li>" + locationNode[k].innerHTML + "</li>"
                        }
                        html_text += "</ul>";
                    }
                } else if (rowNode[j].nodeName == "HomePage") {
                    // TODO: should links open in a new tab/window? Just default?
                    html_text += "<a href=" + rowNode[j].innerHTML + ">" + rowNode[j].innerHTML + "</a>";
                } else if (rowNode[j].nodeName == "Logo") {
                    html_text += "<img src='" + rowNode[j].innerHTML + "'>";
                } else {
                    throw("Error in XML file: invalid tag in a table row.");
                }
                html_text += "</td>";
            }
            //TODO check if can be empty?
            html_text += "</tr>";
        } else {
            throw("Error in XML file: invalid row tag in table.");
        }
    }
    html_text += "</tbody>";
    html_text += "</table>";
    html_text += "</body></html>";
}

function viewXML(what) {
    var URL = what.URL.value;    
    function loadXML(url) {
        // Code for IE7+, Firefox, Chrome, Opera, Safari
        if (window.XMLHttpRequest) {
            xmlhttp = new XMLHttpRequest();
        } else {
            // Code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.open("GET", url, false);
        try {
            xmlhttp.send();
        } catch (e) {
            alert(e);
        }
        xmlDoc = xmlhttp.responseXML;
        return xmlDoc;
    }
    xmlDoc = loadXML(URL);
    // If IE, simply execute script (due to async prop).
    if (window.ActiveXObject) {
        if (xmlDoc.parseError.errorCode != 0) {
            var myErr = xmlDoc.parseError;
            error("Error in XML file");
            hWin = window.open("", "Error", "height=300,width=340");
            hWin.document.write(html_text);
        } else {
            generateHTML(xmlDoc);
            hWin = window.open("", "Assignment4", "height=800,width=600");
            hWin.document.write(html_text);
        }
    } else {
        // Else if FF, execute script once XML object has loaded
        try {
            xmlDoc.onload = generateHTML(xmlDoc);
            hWin = window.open("", "Assignment4", "height=800,width=600");
            hWin.document.write(html_text);
            hWin.document.close();
        } catch (e) {
            alert(e);
        }
    }
}
</script>
</head>

<body>
<div align="center">
    <p>Enter URL for Company List XML File</p>
    <form>
        <input type="text" name="URL" maxlength="255" size="20" />
        <br><br>
        <input type="button" name="submit" value="Submit Query" onClick="viewXML(this.form)" />
    </form>
</div>
<noscript>
</body>
</html>
